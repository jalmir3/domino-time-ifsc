<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partida de Dominó</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/style.css}">
    <script th:src="@{/js/userAvatar.js}"></script>
</head>
<body>
<div class="header">
    <div class="logo">
        <img th:onclick="|window.location.href='@{/home}'|" th:src="@{/images/logo.png}" alt="Logo" class="logo-img">
    </div>
    <div class="buttons">
        <div sec:authorize="isAuthenticated()" class="user-dropdown">
            <i class="fas fa-user-circle user-icon" id="userAvatarIcon"
               th:attr="data-avatar=${#authentication.principal.avatar}"></i>
            <div class="dropdown-content">
                <div class="user-name" th:text="${#authentication.principal.nickname}"></div>
                <a th:href="@{/account}">Gerenciar conta</a>
                <a th:href="@{/groups/create}">Criar partida</a>
                <a th:href="@{/groups/join}">Acessar partida</a>
                <a th:href="@{/matches/my-matches}">Minhas partidas</a>
                <form class="logout-form" th:action="@{/logout}" method="post">
                    <button type="submit" class="btn-exit">Sair</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="form-container">
    <h1 class="title">Registrar Pontuação</h1>
    <h2 class="subtitle" th:text="'Grupo: ' + ${group.name}"></h2>
    <div class="game-info">
        <div class="game-mode">
            <strong>Modo de Jogo:</strong>
            <span id="gameModeBadge" class="game-mode-badge"
                  th:classappend="${gameMode == T(sistema.model.GameMode).TEAMS} ? 'bg-primary' : 'bg-info'"
                  th:text="${gameMode == T(sistema.model.GameMode).TEAMS} ? 'Dupla' : 'Individual'">
            </span>
        </div>
        <div id="matchId" style="display:none" th:text="${match.id}"></div>
    </div>
    <div th:if="${gameMode == T(sistema.model.GameMode).TEAMS}">
        <div th:if="${hasWinner}">
            <div class="alert alert-success">
                <h4>Partida Finalizada!</h4>
                <p th:text="'Vencedor: ' + ${match.winner}"></p>
                <p th:text="'Placar Final - Time A: ' + ${teamAScore} + ' x Time B: ' + ${teamBScore}"></p>
            </div>
        </div>
        <div th:if="${!hasWinner}">
            <form th:action="@{'/matches/' + ${match.id} + '/save-round'}" method="post" id="teamsForm">
                <input type="hidden" name="roundNumber" th:value="${currentRound}">
                <div class="round-info">
                    <h4>Rodada <span th:text="${currentRound}">1</span></h4>
                </div>
                <table class="score-table" id="teamsTable">
                    <thead>
                    <tr class="score-header-row">
                        <th class="score-header">Time</th>
                        <th class="score-header">Jogadores</th>
                        <th class="score-header">Pontuação</th>
                        <th class="score-header">Total</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="score-row">
                        <td class="score-cell">Time A</td>
                        <td class="score-cell">
                            <span th:each="player : ${teamA}" th:text="${player.nickname} + ' '"></span>
                        </td>
                        <td class="score-cell">
                            <input class="score-input team-a-input" type="number" name="teamAScore" value="0" min="0"
                                   required onchange="updateTotals()">
                        </td>
                        <td class="score-cell" id="total-teamA" th:attr="data-base=${teamAScore}" th:text="${teamAScore}">0</td>
                    </tr>
                    <tr class="score-row">
                        <td class="score-cell">Time B</td>
                        <td class="score-cell">
                            <span th:each="player : ${teamB}" th:text="${player.nickname} + ' '"></span>
                        </td>
                        <td class="score-cell">
                            <input class="score-input team-b-input" type="number" name="teamBScore" value="0" min="0"
                                   required onchange="updateTotals()">
                        </td>
                        <td class="score-cell" id="total-teamB" th:attr="data-base=${teamBScore}" th:text="${teamBScore}">0</td>
                    </tr>
                    </tbody>
                </table>
                <input type="hidden" name="teamAPlayerIds" th:value="${#strings.listJoin(teamAPlayerIds, ',')}">
                <input type="hidden" name="teamBPlayerIds" th:value="${#strings.listJoin(teamBPlayerIds, ',')}">
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Salvar Rodada</button>
                </div>
            </form>
            <form th:if="${!hasWinner}" th:action="@{'/matches/' + ${match.id} + '/cancel'}" method="post" class="cancel-form">
                <div class="action-buttons">
                    <button type="submit" class="btn btn-danger"
                            onclick="return confirm('Tem certeza que deseja cancelar esta partida?')">
                        Cancelar Partida
                    </button>
                </div>
            </form>
        </div>
        <div class="history-panel" th:if="${roundsHistory != null and not roundsHistory.empty}">
            <h4 class="title-middle">Última partida</h4>
            <table class="table table-sm">
                <thead>
                <tr>
                    <th>Rodada</th>
                    <th>Dupla</th>
                    <th>Jogadores</th>
                    <th>Pontuação</th>
                    <th>Acumulado</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="score : ${roundsHistory}">
                    <td th:text="${score.roundNumber}">1</td>
                    <td th:text="${score.team}">A</td>
                    <td th:text="${score.user.nickname}">Jogador</td>
                    <td th:text="${score.score}">10</td>
                    <td th:text="${score.totalScore}">20</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="alert alert-info" th:if="${roundsHistory == null or roundsHistory.empty}">
            <i class="fas fa-info-circle"></i> Nenhuma rodada registrada ainda.
        </div>
    </div>
    <div th:if="${gameMode != T(sistema.model.GameMode).TEAMS}">
        <div th:if="${hasWinner}" class="alert alert-success">
            <h4>Partida Finalizada!</h4>
            <p>Vencedor: <span th:text="${match.winner}"></span></p>
        </div>
        <form id="scoreForm" th:action="@{'/matches/' + ${match.id} + '/save-individual-scores'}" method="post"
              th:unless="${hasWinner}">
            <input type="hidden" name="roundNumber" th:value="${currentRound}">
            <div class="round-info">
                <h4>Rodada <span th:text="${currentRound}">1</span></h4>
            </div>
            <div th:if="${players == null or players.empty}" class="alert alert-warning">
                <i class="fas fa-exclamation-circle"></i> Nenhum jogador encontrado para esta partida. Adicione
                jogadores ao grupo antes de continuar.
            </div>
            <table class="score-table" th:unless="${players == null or players.empty}">
                <thead>
                <tr class="score-header-row">
                    <th class="score-header">Jogador</th>
                    <th class="score-header">Pontuação</th>
                    <th class="score-header">Total</th>
                </tr>
                </thead>
                <tbody>
                <tr class="score-row" th:each="player : ${players}">
                    <td class="score-cell" th:text="${player.nickname}">@player</td>
                    <td class="score-cell">
                        <input class="score-input" type="number"
                               name="scores[]"
                               th:value="0" min="0" required>
                        <input type="hidden"
                               name="playerIds[]"
                               th:value="${player.id}">
                    </td>
                    <td class="score-cell total-score" th:id="'total-' + ${player.id}"
                        th:text="${latestScores[player.id]} ?: 0">0</td>
                </tr>
                </tbody>
            </table>
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary">Salvar Rodada</button>
            </div>
        </form>
        <form th:if="${!hasWinner}" th:action="@{'/matches/' + ${match.id} + '/cancel'}" method="post" class="cancel-form">
            <div class="action-buttons">
                <button type="submit" class="btn btn-danger"
                        onclick="return confirm('Tem certeza que deseja cancelar esta partida?')">
                    Cancelar Partida
                </button>
            </div>
        </form>
        <div class="history-panel" th:if="${roundsHistory != null and not roundsHistory.empty}">
            <h4 class="title-middle">Histórico de Rodadas</h4>
            <table class="table table-sm">
                <thead>
                <tr>
                    <th>Rodada</th>
                    <th>Jogador</th>
                    <th>Pontuação</th>
                    <th>Acumulado</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="score : ${roundsHistory}">
                    <td th:text="${score.roundNumber}">1</td>
                    <td th:text="${score.user.nickname}">Jogador</td>
                    <td th:text="${score.score}">10</td>
                    <td th:text="${score.totalScore}">20</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="alert alert-info" th:if="${roundsHistory == null or roundsHistory.empty}">
            <i class="fas fa-info-circle"></i> Nenhuma rodada registrada ainda.
        </div>
    </div>
</div>
<div class="footer-bar">
    Convide seus amigos e comece a marcar suas partidas de dominó agora mesmo!
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userIcons = document.querySelectorAll('.user-icon');
        const dropdownContents = document.querySelectorAll('.dropdown-content');
        userIcons.forEach(icon => {
            icon.addEventListener('click', function(e) {
                e.stopPropagation();
                const dropdown = this.closest('.user-dropdown');
                const content = dropdown.querySelector('.dropdown-content');
                dropdownContents.forEach(dc => {
                    if (dc !== content) {
                        dc.style.display = 'none';
                    }
                });
                content.style.display = content.style.display === 'block' ? 'none' : 'block';
            });
        });
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-dropdown')) {
                dropdownContents.forEach(content => {
                    content.style.display = 'none';
                });
            }
        });
        const matchId = document.getElementById('matchId').textContent;
        const storageKey = `domino_scores_${matchId}`;
        const gameMode = /*[[${gameMode}]]*/ 'INDIVIDUAL';
        let scoreData = {
            players: {},
            history: [],
            teamA: 0,
            teamB: 0,
            baseScores: {}
        };
        document.querySelectorAll('.total-score').forEach(cell => {
            const playerId = cell.id.replace('total-', '');
            const baseScore = parseInt(cell.getAttribute('data-base')) || 0;
            scoreData.baseScores[playerId] = baseScore;
        });
        const saved = localStorage.getItem(storageKey);
        if (saved) {
            const loadedData = JSON.parse(saved);
            scoreData.players = loadedData.players || {};
            scoreData.history = loadedData.history || [];
            scoreData.teamA = loadedData.teamA || 0;
            scoreData.teamB = loadedData.teamB || 0;
            scoreData.baseScores = loadedData.baseScores || {};
            document.querySelectorAll('.total-score').forEach(cell => {
                const playerId = cell.id.replace('total-', '');
                if (scoreData.baseScores[playerId] === undefined) {
                    const baseScore = parseInt(cell.getAttribute('data-base')) || 0;
                    scoreData.baseScores[playerId] = baseScore;
                }
            });
        }
        if (gameMode !== 'TEAMS') {
            updateIndividualTotals();
        } else {
            updateTotals();
        }
        document.querySelectorAll('.score-input').forEach(input => {
            input.addEventListener('input', function() {
                if (gameMode === 'TEAMS') {
                    updateTotals();
                }
                if (gameMode !== 'TEAMS') {
                    updateIndividualTotals();
                }
            });
            input.addEventListener('change', function() {
                const playerId = this.parentNode.querySelector('input[type="hidden"]')?.value;
                const score = parseInt(this.value) || 0;
                if (gameMode === 'TEAMS') {
                    const team = this.name === 'teamAScore' ? 'teamA' : 'teamB';
                    scoreData[team] = score;
                    updateTotals();
                } else {
                    updateScore(playerId, score);
                }
                saveScores();
            });
        });
        function updateScore(playerId, score) {
            scoreData.players[playerId] = score;
            saveScores();
        }
        function updateTotals() {
            if (isTeamsMode()) {
                const teamABase = parseInt(document.getElementById('total-teamA').getAttribute('data-base')) || 0;
                const teamBBase = parseInt(document.getElementById('total-teamB').getAttribute('data-base')) || 0;
                const teamAInput = document.querySelector('.team-a-input');
                const teamBInput = document.querySelector('.team-b-input');
                const teamARound = parseInt(teamAInput.value) || 0;
                const teamBRound = parseInt(teamBInput.value) || 0;
                const totalTeamA = teamABase + teamARound;
                const totalTeamB = teamBBase + teamBRound;
                document.querySelector('.team-score:first-child .score-value').textContent = totalTeamA;
                document.querySelector('.team-score:last-child .score-value').textContent = totalTeamB;
                document.getElementById('total-teamA').textContent = totalTeamA;
                document.getElementById('total-teamB').textContent = totalTeamB;
                scoreData.teamA = teamARound;
                scoreData.teamB = teamBRound;
            }
            saveScores();
        }
        function updateIndividualTotals() {
            document.querySelectorAll('tr.score-row').forEach(row => {
                const input = row.querySelector('input.score-input');
                const totalCell = row.querySelector('.total-score');
                const baseScore = parseInt(totalCell.getAttribute('data-base')) || 0;
                const currentScore = parseInt(input.value) || 0;
                const total = baseScore + currentScore;
                totalCell.textContent = total;
            });
        }
        function saveScores() {
            localStorage.setItem(storageKey, JSON.stringify(scoreData));
        }
        function isTeamsMode() {
            return document.getElementById('gameModeBadge').textContent.trim() === 'Dupla';
        }
    });
</script>
</body>
</html>